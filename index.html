<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Diagrama de Gantt - Proyecto</title>
<style>
  :root{
    --bg: #ffffff;
    --panel: #f6f7f9;
    --text: #222;
    --muted: #6b7280;
    --accent: #0b63b8;
    --accent-dark: #084b86;
    --bar: #0b63b8;
    --bar-border: #07457a;
    --grid: #e6e9ef;
    --font-sans: "Segoe UI", Roboto, Arial, sans-serif;
  }

  html,body{
    height:100%;
    margin:0;
    font-family:var(--font-sans);
    background:var(--bg);
    color:var(--text);
  }

  .container{
    max-width:1120px;
    margin:28px auto;
    padding:24px;
    background:linear-gradient(180deg,var(--panel),#ffffff);
    border-radius:8px;
    box-shadow:0 6px 18px rgba(10,20,40,0.06);
    border:1px solid #e8edf4;
  }

  header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    margin-bottom:14px;
  }

  header h1{
    font-size:20px;
    margin:0;
    color:var(--accent-dark);
  }

  .subtitle{
    color:var(--muted);
    font-size:13px;
    margin-top:4px;
  }

  .controls{
    display:flex;
    gap:8px;
    align-items:center;
  }

  button{
    background:var(--accent);
    color:white;
    border:none;
    padding:10px 14px;
    border-radius:6px;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 2px 6px rgba(11,99,184,0.18);
  }

  .gantt-wrap{
    overflow:auto;
    padding:12px;
    border-radius:6px;
    background:white;
    margin-top:8px;
    border:1px solid #eef3fb;
  }

  /* Ensure SVG scales nicely in container */
  svg { display:block; max-width:100%; height:auto; }

</style>
</head>
<body>
<div class="container">

  <header>
    <div>
      <h1>Diagrama de Gantt — Sistema de Gestión del Mercado</h1>
      <div class="subtitle">Implementación del sistema en 24 semanas</div>
    </div>

    <div class="controls">
      <button id="downloadBtn">Descargar PNG</button>
    </div>
  </header>

  <div class="gantt-wrap">
    <svg id="ganttSvg" xmlns="http://www.w3.org/2000/svg"></svg>
  </div>

</div>

<script>
/* === DATOS DEL PROYECTO === */
const tasks = [
  {
    name: "Fase 1: Análisis de requerimientos",
    start: 1,
    duration: 4,
    details: [
      "• Identificación del problema",
      "• Definición de necesidades",
      "• Determinación de funcionalidades",
      "• Evaluación del flujo de trabajo"
    ]
  },
  {
    name: "Fase 2: Diseño del sistema",
    start: 5,
    duration: 4,
    details: [
      "• Diseño de la interfaz (frontend)",
      "• Diseño de la base de datos",
      "• Estructura de módulos",
      "• Definición de arquitectura backend"
    ]
  },
  {
    name: "Fase 3: Desarrollo del sistema",
    start: 9,
    duration: 8,
    details: [
      "• Desarrollo del frontend en React",
      "• Desarrollo del backend en Node.js",
      "• Conexión con la base de datos",
      "• Implementación de generación de boletas",
      "• Implementación del control de pagos",
      "• Implementación del diseño responsive para garantizar el uso del sistema desde celulares.",
    ]
  },
  {
    name: "Fase 4: Pruebas y correcciones",
    start: 17,
    duration: 4,
    details: [
      "• Pruebas funcionales",
      "• Corrección de errores",
      "• Pruebas con datos reales (Excel)"
    ]
  },
  {
    name: "Fase 5: Despliegue y documentación",
    start: 21,
    duration: 4,
    details: [
      "• Despliegue del frontend (Netlify)",
      "• Despliegue del backend (Render)",
      "• Base de datos en Railway",
      "• Documentación y capacitación"
    ]
  }
];

const totalWeeks = 24;
const svg = document.getElementById("ganttSvg");

const leftMargin = 300;    // espacio para títulos y subtareas
const topMargin = 90;
const rowHeight = 100;
const barHeight = 26;
const weekWidth = 34;

const svgWidth = leftMargin + totalWeeks * weekWidth + 80;
const svgHeight = topMargin + tasks.length * rowHeight + 60;

svg.setAttribute("width", svgWidth);
svg.setAttribute("height", svgHeight);

/* === ENCABEZADO FASE / ACTIVIDAD === */
const headerText = document.createElementNS("http://www.w3.org/2000/svg", "text");
headerText.setAttribute("x", 16);
headerText.setAttribute("y", topMargin - 40);
headerText.setAttribute("font-size", "14");
headerText.setAttribute("font-weight", "700");
headerText.setAttribute("fill", "#084b86");
headerText.textContent = "Fase / Actividad";
svg.appendChild(headerText);

/* === GRID Y SEMANAS === */
for (let w = 1; w <= totalWeeks; w++) {
  const x = leftMargin + (w - 1) * weekWidth;

  const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
  line.setAttribute("x1", x);
  line.setAttribute("y1", topMargin - 26);
  line.setAttribute("x2", x);
  line.setAttribute("y2", svgHeight - 30);
  line.setAttribute("stroke", "#e3e7ef");
  line.setAttribute("stroke-width", "1");
  svg.appendChild(line);

  const lbl = document.createElementNS("http://www.w3.org/2000/svg", "text");
  lbl.setAttribute("x", x + weekWidth / 2);
  lbl.setAttribute("y", topMargin - 34);
  lbl.setAttribute("text-anchor", "middle");
  lbl.setAttribute("font-size", "11");
  lbl.setAttribute("fill", "#6b7280");
  lbl.textContent = "S" + w;
  svg.appendChild(lbl);
}

/* === RENDER DE FASES === */
tasks.forEach((task, i) => {
  const y = topMargin + i * rowHeight;

  // Background band for row (subtle)
  if (i % 2 === 0) {
    const rowBg = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    rowBg.setAttribute("x", 0);
    rowBg.setAttribute("y", y - 22);
    rowBg.setAttribute("width", svgWidth);
    rowBg.setAttribute("height", rowHeight - 10);
    rowBg.setAttribute("fill", "#ffffff");
    svg.appendChild(rowBg);
  }

  // Title (fase)
  const title = document.createElementNS("http://www.w3.org/2000/svg", "text");
  title.setAttribute("x", 16);
  title.setAttribute("y", y - 2);
  title.setAttribute("font-size", "14");
  title.setAttribute("font-weight", "700");
  title.setAttribute("fill", "#0b63b8");
  title.textContent = task.name;
  svg.appendChild(title);

  // Details (subtareas) - render each on its own line with small indent
  task.details.forEach((d, idx) => {
    const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
    txt.setAttribute("x", 26);
    txt.setAttribute("y", y + 14 + idx * 14);
    txt.setAttribute("font-size", "11");
    txt.setAttribute("fill", "#374151");
    txt.textContent = d;
    svg.appendChild(txt);
  });

  // Draw bar for phase
  const barX = leftMargin + (task.start - 1) * weekWidth + 6;
  const barW = Math.max(task.duration * weekWidth - 12, 20); // ensure min width

  const bar = document.createElementNS("http://www.w3.org/2000/svg", "rect");
  bar.setAttribute("x", barX);
  bar.setAttribute("y", y - 16);
  bar.setAttribute("width", barW);
  bar.setAttribute("height", barHeight);
  bar.setAttribute("rx", 6);
  bar.setAttribute("ry", 6);
  bar.setAttribute("fill", "#0b63b8");
  bar.setAttribute("stroke", "#07457a");
  svg.appendChild(bar);

  // Add label inside bar if enough space, otherwise place at bar end
  const labelText = task.name.split(":")[0]; // short label (e.g., "Fase 3")
  const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
  label.setAttribute("font-size", "12");
  label.setAttribute("font-weight", "700");
  label.setAttribute("fill", "#ffffff");
  label.setAttribute("font-family", "Segoe UI, Roboto, Arial");


  // Add short label centered vertically over the bar start (if fits)
  // compute approximate text width (rough calc using char count)
  const approxCharWidth = 7; // rough px per char at font-size 12
  const txtWidth = labelText.length * approxCharWidth;
  if (txtWidth + 16 < barW) {
    // place inside
    label.setAttribute("x", barX + 10);
    label.setAttribute("y", y + 2);
    label.textContent = labelText;
    svg.appendChild(label);
  } else {
    // place left of the bar start
    const alt = document.createElementNS("http://www.w3.org/2000/svg", "text");
    alt.setAttribute("x", leftMargin - 8);
    alt.setAttribute("y", y + 2);
    alt.setAttribute("font-size", "12");
    alt.setAttribute("font-weight", "700");
    alt.setAttribute("text-anchor", "end");
    alt.setAttribute("fill", "#0b63b8");
    alt.textContent = labelText;
    svg.appendChild(alt);
  }

});

/* === DESCARGA PNG === */
document.getElementById("downloadBtn").addEventListener("click", () => {
  // Serialize current SVG and force width/height for good resolution
  const serializer = new XMLSerializer();
  const svgString = serializer.serializeToString(svg);
  const blob = new Blob([svgString], {type:"image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const img = new Image();
  img.onload = () => {
    const canvas = document.createElement("canvas");
    canvas.width = img.width * 2.5;
    canvas.height = img.height * 2.5;
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    canvas.toBlob(blob => {
      const link = document.createElement("a");
      link.download = "diagrama_gantt_proyecto.png";
      link.href = URL.createObjectURL(blob);
      link.click();
    }, "image/png");
  };
  img.onerror = () => {
    alert('Error al convertir SVG a imagen. Intenta en otro navegador.');
  };
  img.src = url;
});
</script>

</body>
</html>
